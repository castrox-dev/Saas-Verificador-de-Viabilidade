<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Verificador De Viabilidade</title>
    
    <!-- Meta Tags -->
    <meta name="description" content="Sistema de verificaÃ§Ã£o de viabilidade FTTH com mapas interativos">
    <meta name="theme-color" content="#ff6600">
    
    {% load static %}
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'icon.ico' %}">
    <!-- Preconnect hints para reduzir DNS/TLS e acelerar requisiÃ§Ãµes -->
    <link rel="preconnect" href="https://unpkg.com" crossorigin>
    <link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
    <link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin>
    <link rel="preconnect" href="https://b.tile.openstreetmap.org" crossorigin>
    <link rel="preconnect" href="https://c.tile.openstreetmap.org" crossorigin>
    <link rel="preconnect" href="https://viacep.com.br" crossorigin>
    <link rel="preconnect" href="https://brasilapi.com.br" crossorigin>
    <link rel="preconnect" href="https://nominatim.openstreetmap.org" crossorigin>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Tema SaaS compartilhado -->
    <link rel="stylesheet" href="{% static 'css/theme_colors.css' %}">
    <link rel="stylesheet" href="{% static 'ftth_viewer/style.css' %}">
    <link rel="stylesheet" href="{% static 'ftth_viewer/mobile.css' %}">

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" defer></script>
</head>
<body>
    <!-- CabeÃ§alho -->
    <header class="header">
        <div class="header-content">
            <h1>RM Systems</h1>
        </div>
    </header>

    <!-- Barra superior com pesquisa e controles -->
    <div class="top-bar">
        <!-- BotÃ£o de menu hambÃºrguer -->
        <button id="menu-toggle" class="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        {% if user.is_authenticated and user.is_company_admin or user.is_authenticated and user.is_rm_admin or user.is_authenticated and user.is_superuser %}
        <a class="menu-admin-link" href="{% if user.is_rm_admin or user.is_superuser %}/rm/admin/{% else %}/{{ company_slug }}/painel/{% endif %}">
            <i class="fas fa-tachometer-alt"></i>
            <span>Ir para o Painel</span>
        </a>
        {% endif %}
        
        <!-- Barra de pesquisa principal -->
        <div class="search-container">
            <div class="search-input-wrapper">
                <input type="text" id="search-input" class="search-input" placeholder="Pesquisar endereÃ§o, CEP ou coordenadas...">
                <button id="search-btn" class="search-btn" title="Pesquisar">
                    <i class="fas fa-search"></i>
                </button>
                <button id="filter-btn" class="filter-btn" title="Filtros de pesquisa" style="display: none;">
                    <i class="fas fa-filter"></i>
                </button>
                <button id="history-btn" class="history-btn" title="HistÃ³rico de pesquisas" style="display: none;">
                    <i class="fas fa-history"></i>
                </button>
            </div>
            
            <!-- Dropdown de sugestÃµes -->
            <div class="search-suggestions-dropdown" style="display: none;"></div>
            
            <!-- Dropdown de histÃ³rico -->
            <div class="history-dropdown" style="display: none;"></div>
            
            <!-- Dropdown de filtros -->
            <div class="filter-dropdown" style="display: none;"></div>
            
            <div id="search-results" class="search-results" style="display: none;"></div>
        </div>
        
        <!-- BotÃ£o de alternÃ¢ncia do cursor -->
        <div class="cursor-toggle-container">
            <button id="cursor-toggle-btn" class="cursor-toggle-btn" title="Alternar para modo de marcaÃ§Ã£o">
                <i class="fas fa-hand-pointer"></i>
                <span class="cursor-mode-text">Navegar</span>
            </button>
        </div>

        <!-- BotÃ£o de Adicionar CTO (apenas para admins) -->
        {% if user.is_authenticated and user.is_company_admin or user.is_authenticated and user.is_rm_admin %}
        <div class="add-cto-toggle-container">
            <button id="add-cto-toggle-btn" class="add-cto-toggle-btn" title="Adicionar CTO no mapa">
                <i class="fas fa-map-marker-alt"></i>
                <span class="add-cto-mode-text">Adicionar CTO</span>
            </button>
        </div>
        {% endif %}

        <!-- BotÃ£o de Dark Mode -->
        <div class="theme-toggle-container">
            <button id="theme-toggle-btn" class="theme-toggle-btn" title="Alternar tema">
                <i class="fas fa-moon"></i>
            </button>
        </div>

    </div>

    <!-- Sidebar Profissional -->
    <div id="sidebar" class="sidebar">
        <!-- Header da Sidebar -->
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="brand-icon-sidebar">
                    <i class="fas fa-network-wired"></i>
                </div>
                <div class="brand-text">
                    <h1 class="sidebar-title">FTTH Viewer</h1>
                    <p class="sidebar-subtitle">Verificador De Viabilidade</p>
                </div>
            </div>
        </div>

        <!-- ConteÃºdo da Sidebar -->
        <div class="sidebar-content">

            <!-- CTOs DisponÃ­veis -->
            <section class="sidebar-section">
                <div class="section-header">
                    <div class="section-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <h2 class="section-title">CTOs DisponÃ­veis</h2>
                    <button id="refresh-maps-btn" class="refresh-maps-btn" title="Atualizar lista de mapas" onclick="loadCTOFiles(true)">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="cto-grid"><!-- preenchido dinamicamente via API --></div>
            </section>
        </div>
    </div>

    <!-- Overlay para mobile -->
    <div id="overlay" class="overlay" aria-hidden="true"></div>

    <!-- Mapa em tela cheia -->
    <div id="map"></div>

    <!-- Popup de Adicionar CTO (apenas para admins) -->
    {% if user.is_authenticated and user.is_company_admin or user.is_authenticated and user.is_rm_admin %}
    <div id="add-cto-popup" class="add-cto-popup" style="display: none;">
        <div class="add-cto-popup-content">
            <div class="add-cto-popup-header">
                <h3>Adicionar CTO</h3>
                <button id="close-add-cto-popup" class="close-add-cto-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-cto-form" class="add-cto-form">
                <div class="form-group">
                    <label for="cto-name">Nome do CTO *</label>
                    <input type="text" id="cto-name" name="nome_cto" required placeholder="Ex: CTO Centro">
                </div>
                <div class="form-group">
                    <label for="cto-map">Selecione o Mapa *</label>
                    <select id="cto-map" name="map_id" required>
                        <option value="">Carregando mapas...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Coordenadas</label>
                    <div class="coords-display">
                        <span id="cto-lat-display">-</span>, <span id="cto-lon-display">-</span>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-add-cto" class="btn-cancel">Cancelar</button>
                    <button type="submit" id="save-cto" class="btn-save">Salvar CTO</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Loading Screen -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-icon">
                <i class="fas fa-network-wired"></i>
            </div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Verificando viabilidade...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar"></div>
            </div>
            <div class="loading-subtext">Analisando CTOs prÃ³ximos e calculando rotas</div>
        </div>
    </div>

    <!-- JavaScript separado -->
    <script>
        // Disponibilizar CSRF token globalmente
        window.csrfToken = '{{ csrf_token }}';
        window.IS_ADMIN = {% if user.is_authenticated and user.is_company_admin or user.is_authenticated and user.is_rm_admin or user.is_authenticated and user.is_superuser %}true{% else %}false{% endif %};
        window.COMPANY_SLUG = '{{ company_slug|default_if_none:"" }}';
    </script>
    <script src="{% static 'ftth_viewer/js/app.js' %}" defer></script>
    
    <!-- Script de teste inline para dark mode -->
    <script>
        
        // Teste imediato quando o script carrega
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ§ª DOM carregado, testando elementos...');
            
            const themeBtn = document.getElementById('theme-toggle-btn');
            console.log('ðŸ§ª BotÃ£o de tema encontrado:', !!themeBtn);
            
            if (themeBtn) {
                console.log('ðŸ§ª Adicionando teste de clique...');
                themeBtn.addEventListener('click', function() {
                    console.log('ðŸ§ª TESTE: BotÃ£o clicado!');
                    
                    // Teste manual do tema
                    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    
                    console.log('ðŸ§ª TESTE: Alterando tema de', currentTheme, 'para', newTheme);
                    
                    document.documentElement.setAttribute('data-theme', newTheme);
                    document.body.setAttribute('data-theme', newTheme);
                    
                    // Teste visual imediato
                    document.body.style.backgroundColor = newTheme === 'dark' ? '#1a1a1a' : '#ffffff';
                    document.body.style.color = newTheme === 'dark' ? '#ffffff' : '#1a1a1a';
                    
                    console.log('ðŸ§ª TESTE: Tema aplicado:', newTheme);
                });
            }
        });
    </script>
</body>
</html>

