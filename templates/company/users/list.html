{% extends 'base.html' %}

{% block title %}Usuários - {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="fas fa-users me-2"></i>
          Usuários da Empresa
        </h2>
        <a href="{% url 'company:user_create' company.slug %}" class="btn btn-primary">
          <i class="fas fa-user-plus me-2"></i> Novo Usuário
        </a>
      </div>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      {% if users %}
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>E-mail</th>
                  <th>Telefone</th>
                  <th>Função</th>
                  <th>Status</th>
                  <th class="text-end">Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for u in users %}
                  <tr>
                    <td><strong>{{ u.get_full_name|default:u.username }}</strong></td>
                    <td>{{ u.email }}</td>
                    <td>{{ u.phone|default:'-' }}</td>
                    <td>{{ u.get_role_display }}</td>
                    <td>
                      {% if u.is_active %}
                        <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Ativo</span>
                      {% else %}
                        <span class="badge bg-secondary"><i class="fas fa-times-circle me-1"></i>Inativo</span>
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <div class="btn-group" role="group">
                        <a href="{% url 'company:user_edit' company.slug u.id %}" class="btn btn-sm btn-outline-primary" title="Editar">
                          <i class="fas fa-edit"></i>
                        </a>
                        {% if not u.is_superuser and u.id != user.id %}
                          <button type="button"
                                  class="btn btn-sm btn-outline-{% if u.is_active %}warning{% else %}success{% endif %} js-toggle-user"
                                  data-user-id="{{ u.id }}"
                                  title="{% if u.is_active %}Desativar{% else %}Ativar{% endif %}">
                            <i class="fas fa-{% if u.is_active %}pause{% else %}play{% endif %}"></i>
                          </button>
                          <button type="button"
                                  class="btn btn-sm btn-outline-danger js-delete-user"
                                  data-user-id="{{ u.id }}"
                                  data-user-name="{{ u.get_full_name|default:u.username }}"
                                  title="Remover usuário">
                            <i class="fas fa-trash"></i>
                          </button>
                        {% endif %}
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% else %}
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> Nenhum usuário cadastrado para {{ company.name }}.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal de confirmação para remover usuário -->
<div id="delete-user-modal" class="delete-modal" style="display: none;">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <h5>
        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
        Confirmar Remoção
      </h5>
      <button type="button" class="delete-modal-close" id="close-delete-modal-btn" aria-label="Fechar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="delete-modal-body">
      <p class="mb-3">
        Tem certeza que deseja <strong>REMOVER</strong> o usuário <strong id="delete-modal-user-name"></strong>?
      </p>
      <div class="alert alert-warning mb-0">
        <i class="fas fa-exclamation-circle me-2"></i>
        <strong>Atenção:</strong> Esta ação não pode ser desfeita!
      </div>
    </div>
    <div class="delete-modal-footer">
      <button type="button" class="btn btn-secondary btn-cancel" id="cancel-delete-btn">
        <i class="fas fa-times me-2"></i>
        Cancelar
      </button>
      <button type="button" class="btn btn-danger" id="confirm-delete-btn">
        <i class="fas fa-trash me-2"></i>
        Remover Usuário
      </button>
    </div>
  </div>
</div>

<style>
  /* Modal de confirmação customizado */
  .delete-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
  }

  .delete-modal-content {
    background: var(--rm-card-bg, #ffffff);
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease-out;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .delete-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--rm-border-primary, #e2e8f0);
  }

  .delete-modal-header h5 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--rm-text-primary, #1f2937);
    display: flex;
    align-items: center;
  }

  .delete-modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--rm-text-secondary, #6b7280);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .delete-modal-close:hover {
    background-color: var(--rm-bg-secondary, #f3f4f6);
    color: var(--rm-text-primary, #1f2937);
  }

  .delete-modal-body {
    padding: 1.5rem;
    color: var(--rm-text-primary, #1f2937);
  }

  .delete-modal-body p {
    font-size: 1rem;
    line-height: 1.6;
    margin: 0;
  }

  .delete-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1.25rem 1.5rem;
    border-top: 1px solid var(--rm-border-primary, #e2e8f0);
  }

  .delete-modal-footer .btn {
    min-width: 140px;
  }

  /* Dark mode */
  [data-theme="dark"] .delete-modal-content {
    background: var(--rm-card-bg, #1f2937);
    border: 1px solid var(--rm-border-primary, #374151);
  }

  [data-theme="dark"] .delete-modal-header {
    border-bottom-color: var(--rm-border-primary, #374151);
  }

  [data-theme="dark"] .delete-modal-footer {
    border-top-color: var(--rm-border-primary, #374151);
  }

  /* Mobile */
  @media (max-width: 576px) {
    .delete-modal-content {
      width: 95%;
      margin: 1rem;
    }

    .delete-modal-header,
    .delete-modal-body,
    .delete-modal-footer {
      padding: 1rem;
    }

    .delete-modal-footer {
      flex-direction: column;
    }

    .delete-modal-footer .btn {
      width: 100%;
    }
  }
</style>

<script>
// Variáveis globais para o modal de exclusão
let deleteForm = null;
let deleteUserName = null;

// Função para obter CSRF token
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}

// Funções do modal de exclusão (no escopo global)
window.showDeleteModal = function(userName) {
  const modal = document.getElementById('delete-user-modal');
  const modalUserName = document.getElementById('delete-modal-user-name');
  
  if (modalUserName) {
    modalUserName.textContent = userName;
  }
  
  if (modal) {
    modal.style.display = 'flex';
    // Focar no botão cancelar por padrão (mais seguro)
    const cancelBtn = modal.querySelector('.btn-cancel');
    if (cancelBtn) {
      setTimeout(() => cancelBtn.focus(), 100);
    }
  }
};

window.closeDeleteModal = function() {
  const modal = document.getElementById('delete-user-modal');
  if (modal) {
    modal.style.display = 'none';
  }
  deleteForm = null;
  deleteUserName = null;
};

window.confirmDelete = function() {
  if (!deleteForm) {
    return;
  }
  
  // Criar formulário e submeter via POST
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = deleteForm.action;
  
  // Adicionar CSRF token
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrfmiddlewaretoken';
  csrfInput.value = deleteForm.csrfToken;
  form.appendChild(csrfInput);
  
  // Fechar modal
  window.closeDeleteModal();
  
  // Adicionar ao body e submeter
  document.body.appendChild(form);
  form.submit();
};

// Inicialização quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
  const csrftoken = getCookie('csrftoken');

  // Toggle de status do usuário
  document.querySelectorAll('.js-toggle-user').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-user-id');
      const confirmed = confirm('Tem certeza que deseja alterar o status deste usuário?');
      if (!confirmed) return;
      try {
        const base = `{% url 'company:user_toggle' company.slug 0 %}`;
        const url = base.replace('/0/', `/${id}/`);
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
          },
          credentials: 'same-origin',
        });
        const data = await resp.json();
        if (data.success) {
          location.reload();
        } else {
          alert(data.message || 'Erro ao alterar status do usuário');
        }
      } catch (e) {
        // Suprimir erro em produção
      }
    });
  });

  // Event listeners para os botões do modal de exclusão
  document.querySelectorAll('.js-delete-user').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-user-id');
      const userName = btn.getAttribute('data-user-name');
      
      // Armazenar informações para uso no modal
      deleteUserName = userName;
      deleteForm = {
        method: 'POST',
        action: `{% url 'company:user_delete' company.slug 0 %}`.replace('/0/', `/${id}/`),
        csrfToken: csrftoken
      };
      
      // Mostrar modal de confirmação
      window.showDeleteModal(userName);
    });
  });

  // Event listeners para os botões do modal
  const closeBtn = document.getElementById('close-delete-modal-btn');
  const cancelBtn = document.getElementById('cancel-delete-btn');
  const confirmBtn = document.getElementById('confirm-delete-btn');
  
  if (closeBtn) {
    closeBtn.addEventListener('click', window.closeDeleteModal);
  }
  
  if (cancelBtn) {
    cancelBtn.addEventListener('click', window.closeDeleteModal);
  }
  
  if (confirmBtn) {
    confirmBtn.addEventListener('click', window.confirmDelete);
  }

  // Fechar modal ao clicar fora
  window.addEventListener('click', (e) => {
    const modal = document.getElementById('delete-user-modal');
    if (e.target === modal) {
      window.closeDeleteModal();
    }
  });

  // Fechar modal com ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const modal = document.getElementById('delete-user-modal');
      if (modal && modal.style.display === 'flex') {
        window.closeDeleteModal();
      }
    }
  });
});
</script>
{% endblock %}