{% extends 'base.html' %}
{% load static %}

{% block title %}Ticket {{ ticket.ticket_number }} - RM Systems{% endblock %}

{% block content %}
<style>
  .chat-container {
    display: flex;
    flex-direction: column;
    height: 600px;
    border: 1px solid var(--rm-border-primary, #dee2e6);
    border-radius: 8px;
    background: var(--rm-card-bg, #ffffff);
  }
  .chat-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--rm-border-primary, #dee2e6);
    background: var(--rm-bg-secondary, #f8f9fa);
    border-radius: 8px 8px 0 0;
  }
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: var(--rm-bg-primary, #ffffff);
  }
  .message {
    margin-bottom: 20px;
    display: flex;
    align-items: flex-start;
  }
  .message.sent-by-me {
    flex-direction: row-reverse;
  }
  .message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
  }
  .message.sent-by-me .message-bubble {
    background: var(--rm-primary, #1D4ED8);
    color: white;
  }
  .message:not(.sent-by-me) .message-bubble {
    background: var(--rm-bg-secondary, #e9ecef);
    color: var(--rm-text-primary, #212529);
  }
  .message-meta {
    font-size: 0.75rem;
    color: var(--rm-text-secondary, #6c757d);
    margin-top: 5px;
    padding: 0 10px;
  }
  .chat-input {
    padding: 15px 20px;
    border-top: 1px solid var(--rm-border-primary, #dee2e6);
    background: var(--rm-bg-secondary, #f8f9fa);
    border-radius: 0 0 8px 8px;
  }
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="fas fa-ticket-alt me-2"></i>
          Ticket {{ ticket.ticket_number }}
        </h2>
        <a href="{% url 'rm:ticket_list' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left me-2"></i> Voltar
        </a>
      </div>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      <div class="row">
        <!-- Informações do Ticket -->
        <div class="col-md-4 mb-4">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Informações do Ticket</h5>
            </div>
            <div class="card-body">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="update_status" value="1">
                
                <div class="mb-3">
                  <label class="form-label"><strong>Título:</strong></label>
                  <p>{{ ticket.title }}</p>
                </div>

                <div class="mb-3">
                  <label class="form-label"><strong>Empresa:</strong></label>
                  <p>{{ ticket.company.name }}</p>
                </div>

                <div class="mb-3">
                  <label class="form-label"><strong>Criado por:</strong></label>
                  <p>{{ ticket.created_by.get_full_name|default:ticket.created_by.username }}</p>
                  <small class="text-muted">{{ ticket.created_by.email }}</small>
                </div>

                <div class="mb-3">
                  <label for="status" class="form-label"><strong>Status:</strong></label>
                  <select name="status" id="status" class="form-select" required>
                    <option value="aberto" {% if ticket.status == 'aberto' %}selected{% endif %}>Aberto</option>
                    <option value="em_andamento" {% if ticket.status == 'em_andamento' %}selected{% endif %}>Em Andamento</option>
                    <option value="aguardando_cliente" {% if ticket.status == 'aguardando_cliente' %}selected{% endif %}>Aguardando Cliente</option>
                    <option value="resolvido" {% if ticket.status == 'resolvido' %}selected{% endif %}>Resolvido</option>
                    <option value="fechado" {% if ticket.status == 'fechado' %}selected{% endif %}>Fechado</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="assigned_to" class="form-label"><strong>Atribuído a:</strong></label>
                  <select name="assigned_to" id="assigned_to" class="form-select">
                    <option value="">-- Não atribuído --</option>
                    {% for admin in rm_admins %}
                      <option value="{{ admin.id }}" {% if ticket.assigned_to == admin %}selected{% endif %}>
                        {{ admin.get_full_name|default:admin.username }}
                      </option>
                    {% endfor %}
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label"><strong>Prioridade:</strong></label>
                  <span class="badge" style="background-color: {{ ticket.get_priority_color }}; color: white;">
                    {{ ticket.get_priority_display }}
                  </span>
                </div>

                <div class="mb-3">
                  <label class="form-label"><strong>Descrição:</strong></label>
                  <p class="text-muted">{{ ticket.description|linebreaks }}</p>
                </div>

                <button type="submit" class="btn btn-primary w-100 mb-3">
                  <i class="fas fa-save me-2"></i> Atualizar Status
                </button>
              </form>
              
              {% if ticket.status != 'fechado' %}
              <form method="post" style="display: inline; width: 100%;">
                {% csrf_token %}
                <button type="submit" name="close_ticket" class="btn btn-danger w-100 mb-0" onclick="return confirm('Tem certeza que deseja fechar este ticket? Você não poderá adicionar mais mensagens após fechá-lo.');">
                  <i class="fas fa-lock me-2"></i> Fechar Ticket
                </button>
              </form>
              {% else %}
              <div class="alert alert-secondary mb-0">
                <i class="fas fa-lock me-2"></i> Este ticket está fechado.
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Chat -->
        <div class="col-md-8">
          <div class="card">
            <div class="card-body p-0">
              <div class="chat-container">
                <div class="chat-header">
                  <h5 class="mb-0">
                    <i class="fas fa-comments me-2"></i>
                    Conversa sobre o Ticket
                  </h5>
                </div>

                <div class="chat-messages" id="chatMessages">
                  {% for msg in messages %}
                    <div class="message {% if msg.sent_by == request.user %}sent-by-me{% endif %}" data-message-id="{{ msg.id }}">
                      <div>
                        <div class="message-bubble">
                          {{ msg.message|linebreaks }}
                        </div>
                        <div class="message-meta">
                          <strong>{{ msg.sent_by.get_full_name|default:msg.sent_by.username }}</strong>
                          - {{ msg.created_at|date:"d/m/Y H:i" }}
                        </div>
                      </div>
                    </div>
                  {% empty %}
                    <div class="text-center text-muted py-5">
                      <i class="fas fa-comments fa-3x mb-3"></i>
                      <p>Nenhuma mensagem ainda.</p>
                    </div>
                  {% endfor %}
                </div>

                <div class="chat-input">
                  {% if ticket.status != 'fechado' %}
                  <form method="post" id="messageForm">
                    {% csrf_token %}
                    <div class="input-group">
                      {{ form.message }}
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i> Enviar
                      </button>
                    </div>
                    {% if form.message.errors %}
                      <div class="text-danger small mt-2">{{ form.message.errors }}</div>
                    {% endif %}
                  </form>
                  {% else %}
                  <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i> Este ticket está fechado. Não é possível adicionar novas mensagens.
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Auto-scroll para a última mensagem
  const chatMessages = document.getElementById('chatMessages');
  if (chatMessages) {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Atualizar mensagens a cada 5 segundos
  let lastMessageId = {% if messages %}{% for msg in messages %}{% if forloop.last %}{{ msg.id|default:0 }}{% endif %}{% empty %}0{% endfor %}{% else %}0{% endif %};
  
  setInterval(function() {
    fetch('{% url "rm:get_new_messages" ticket.id %}?last_message_id=' + lastMessageId)
      .then(response => response.json())
      .then(data => {
        if (data.has_new && data.messages.length > 0) {
          data.messages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (msg.is_sent_by_me ? 'sent-by-me' : '');
            messageDiv.dataset.messageId = msg.id;
            messageDiv.innerHTML = `
              <div>
                <div class="message-bubble">${msg.message.replace(/\n/g, '<br>')}</div>
                <div class="message-meta">
                  <strong>${msg.sent_by}</strong> - ${msg.created_at}
                </div>
              </div>
            `;
            chatMessages.appendChild(messageDiv);
            lastMessageId = Math.max(lastMessageId, msg.id);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      })
      .catch(error => {
        // Silenciosamente falhar em produção
      });
  }, 5000);
</script>
{% endblock %}

