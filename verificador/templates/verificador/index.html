{% extends 'base.html' %}
{% load static %}

{% block title %}Verificador de Viabilidade - {{ company.name }}{% endblock %}

{% block body_class %}verificador-page{% endblock %}

{% block extra_head %}
<!-- Meta Tags -->
<meta name="description" content="Sistema de verificação de viabilidade FTTH com mapas interativos">
<meta name="theme-color" content="#ff6600">

<!-- Preconnect hints para reduzir DNS/TLS e acelerar requisições -->
<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
<link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin>
<link rel="preconnect" href="https://b.tile.openstreetmap.org" crossorigin>
<link rel="preconnect" href="https://c.tile.openstreetmap.org" crossorigin>
<link rel="preconnect" href="https://viacep.com.br" crossorigin>
<link rel="preconnect" href="https://brasilapi.com.br" crossorigin>
<link rel="preconnect" href="https://nominatim.openstreetmap.org" crossorigin>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'verificador/css/style.css' %}">
<link rel="stylesheet" href="{% static 'verificador/css/mobile.css' %}">

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" defer></script>
{% endblock %}

{% block content %}
<!-- Barra superior com pesquisa e controles -->
<div class="top-bar">
    <!-- Botão de menu hambúrguer -->
    <button id="menu-toggle" class="menu-toggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Barra de pesquisa principal -->
    <div class="search-container">
        <div class="search-input-wrapper">
            <input type="text" id="search-input" class="search-input" placeholder="Pesquisar endereço, CEP ou coordenadas...">
            <button id="search-btn" class="search-btn" title="Pesquisar">
                <i class="fas fa-search"></i>
            </button>
            <button id="filter-btn" class="filter-btn" title="Filtros de pesquisa" style="display: none;">
                <i class="fas fa-filter"></i>
            </button>
            <button id="history-btn" class="history-btn" title="Histórico de pesquisas" style="display: none;">
                <i class="fas fa-history"></i>
            </button>
        </div>
        
        <!-- Dropdown de sugestões -->
        <div class="search-suggestions-dropdown" style="display: none;"></div>
        
        <!-- Dropdown de histórico -->
        <div class="history-dropdown" style="display: none;"></div>
        
        <!-- Dropdown de filtros -->
        <div class="filter-dropdown" style="display: none;"></div>
        
        <div id="search-results" class="search-results" style="display: none;"></div>
    </div>
    
    <!-- Botão de alternância do cursor -->
    <div class="cursor-toggle-container">
        <button id="cursor-toggle-btn" class="cursor-toggle-btn" title="Alternar para modo de marcação">
            <i class="fas fa-hand-pointer"></i>
            <span class="cursor-mode-text">Navegar</span>
        </button>
    </div>

    <!-- Botão de Dark Mode -->
    <div class="theme-toggle-container">
        <button id="theme-toggle-btn" class="theme-toggle-btn" title="Alternar tema">
            <i class="fas fa-moon"></i>
        </button>
    </div>
</div>

<!-- Sidebar Profissional -->
<div id="sidebar" class="sidebar">
    <!-- Header da Sidebar -->
    <div class="sidebar-header">
        <div class="sidebar-brand">
            <div class="brand-icon-sidebar">
                <i class="fas fa-network-wired"></i>
            </div>
            <div class="brand-text">
                <h1 class="sidebar-title">FTTH Viewer</h1>
                <p class="sidebar-subtitle">Verificador De Viabilidade</p>
                <p class="company-name">{{ company.name }}</p>
            </div>
        </div>
    </div>

    <!-- Conteúdo da Sidebar -->
    <div class="sidebar-content">
        <!-- CTOs Disponíveis -->
        <section class="sidebar-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-map-marked-alt"></i>
                </div>
                <h2 class="section-title">CTOs Disponíveis</h2>
            </div>
            <div class="cto-grid" id="cto-grid">
                <!-- Arquivos serão carregados dinamicamente via JavaScript -->
                <div class="loading-ctos">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Carregando CTOs...</span>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Overlay para mobile -->
<div id="overlay" class="overlay" aria-hidden="true"></div>

<!-- Mapa em tela cheia -->
<div id="map"></div>

<!-- Loading Screen -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <div class="loading-icon">
            <i class="fas fa-network-wired"></i>
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-text">Verificando viabilidade...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
        <div class="loading-subtext">Analisando CTOs próximos e calculando rotas</div>
    </div>
</div>

<!-- JavaScript separado -->
<script src="{% static 'verificador/js/app.js' %}" defer></script>

<!-- Script de configuração -->
<script>
    // Configurações do verificador
    window.verificadorConfig = {
        companySlug: '{{ company.slug }}',
        apiUrls: {
            arquivos: '{% url "verificador:listar_arquivos" company.slug %}',
            coordenadas: '{% url "verificador:obter_coordenadas" company.slug %}',
            verificarViabilidade: '{% url "verificador:verificar_viabilidade" company.slug %}',
            geocode: '{% url "verificador:geocode" %}'
        }
    };
</script>
{% endblock %}
