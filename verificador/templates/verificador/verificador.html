{% extends 'base.html' %}
{% load static %}

{% block title %}Verificador de Viabilidade - {{ company.name }}{% endblock %}

{% block body_class %}verificador-page{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/verificador.css' %}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  .verificador-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .map-container {
    height: 500px;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 20px;
  }
  
  .results-card {
    margin-top: 20px;
    padding: 20px;
    border-radius: 10px;
    background: var(--rm-card-bg);
    border: 1px solid var(--rm-border);
  }
  
  .viability-badge {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
  }
  
  .viability-viable {
    background: #d4edda;
    color: #155724;
  }
  
  .viability-limited {
    background: #fff3cd;
    color: #856404;
  }
  
  .viability-inviable {
    background: #f8d7da;
    color: #721c24;
  }
</style>
{% endblock %}

{% block content %}
<div class="verificador-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>
            <i class="fas fa-search me-2"></i>
            Verificador de Viabilidade - {{ company.name }}
        </h3>
    </div>

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Verificar Viabilidade por Coordenadas</h5>
            <p class="text-muted">Digite um endereço ou coordenadas para verificar viabilidade de instalação FTTH</p>
            
            <div class="row mb-3">
                <div class="col-md-8">
                    <label for="address-input">Endereço</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="address-input" placeholder="Ex: Rua Exemplo, 123 - Rio de Janeiro">
                        <button class="btn btn-primary" onclick="geocodeAddress()">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="lat-input">Latitude</label>
                    <input type="number" step="any" class="form-control" id="lat-input" placeholder="-22.9068">
                </div>
                <div class="col-md-4">
                    <label for="lng-input">Longitude</label>
                    <input type="number" step="any" class="form-control" id="lng-input" placeholder="-43.1729">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="verifyCoordinates()">
                        <i class="fas fa-check"></i> Verificar
                    </button>
                </div>
            </div>
            
            <div class="map-container" id="map"></div>
            
            <div id="coordinates-results" class="results-card" style="display: none;">
                <h5>Resultados da Verificação</h5>
                <div id="coordinates-results-content"></div>
            </div>
        </div>
    </div>
</div>

<script>
let map, marker, routeLayer;

// Inicializar mapa
document.addEventListener('DOMContentLoaded', function() {
    initMap();
});

function initMap() {
    map = L.map('map').setView([-22.9068, -43.1729], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);
    
    // Permitir clique no mapa para definir coordenadas
    map.on('click', function(e) {
        document.getElementById('lat-input').value = e.latlng.lat.toFixed(6);
        document.getElementById('lng-input').value = e.latlng.lng.toFixed(6);
    });
}

async function geocodeAddress() {
    const address = document.getElementById('address-input').value;
    if (!address) {
        alert('Digite um endereço');
        return;
    }
    
    try {
        const response = await fetch(`{% url "verificador:geocode" %}?endereco=${encodeURIComponent(address)}`);
        const data = await response.json();
        
        if (data.lat && data.lng) {
            document.getElementById('lat-input').value = data.lat;
            document.getElementById('lng-input').value = data.lng;
            
            // Atualizar mapa
            map.setView([data.lat, data.lng], 15);
            if (marker) map.removeLayer(marker);
            marker = L.marker([data.lat, data.lng]).addTo(map);
            marker.bindPopup(data.endereco_completo || address).openPopup();
        } else {
            alert('Endereço não encontrado');
        }
    } catch (error) {
        alert('Erro ao geocodificar: ' + error.message);
    }
}

async function verifyCoordinates() {
    const lat = parseFloat(document.getElementById('lat-input').value);
    const lng = parseFloat(document.getElementById('lng-input').value);
    
    if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
        alert('Digite coordenadas válidas');
        return;
    }
    
    // Limpar resultados anteriores
    document.getElementById('coordinates-results').style.display = 'none';
    if (routeLayer) map.removeLayer(routeLayer);
    
    try {
        const response = await fetch(`{% url "verificador:verificar_viabilidade" company.slug %}?lat=${lat}&lon=${lng}`);
        const data = await response.json();
        
        if (data.erro) {
            alert('Erro: ' + data.erro);
            return;
        }
        
        displayCoordinatesResults(data);
        
        // Atualizar mapa
        map.setView([lat, lng], 13);
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`Coordenada verificada:<br>${lat.toFixed(6)}, ${lng.toFixed(6)}`).openPopup();
        
        // CTO mais próximo
        if (data.cto) {
            const ctoMarker = L.marker([data.cto.lat, data.cto.lon], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                })
            }).addTo(map);
            ctoMarker.bindPopup(`<b>CTO:</b> ${data.cto.nome || 'N/A'}`).openPopup();
        }
        
        // Desenhar rota
        if (data.rota && data.rota.geometria) {
            if (routeLayer) map.removeLayer(routeLayer);
            routeLayer = L.polyline(
                data.rota.geometria.map(coord => [coord[1], coord[0]]),
                {color: '#007bff', weight: 4, opacity: 0.7}
            ).addTo(map);
            map.fitBounds(routeLayer.getBounds());
        }
    } catch (error) {
        alert('Erro ao verificar: ' + error.message);
    }
}

function displayCoordinatesResults(data) {
    const content = document.getElementById('coordinates-results-content');
    const viability = data.viabilidade || {};
    
    let badgeClass = 'viability-inviable';
    if (viability.status === 'Viável') badgeClass = 'viability-viable';
    else if (viability.status === 'Viabilidade Limitada') badgeClass = 'viability-limited';
    
    const html = `
        <div class="row">
            <div class="col-md-6">
                <h6>Status de Viabilidade</h6>
                <span class="viability-badge ${badgeClass}">${viability.status || 'N/A'}</span>
                <p class="mt-2">${viability.descricao || ''}</p>
                
                <h6 class="mt-3">Distância até CTO</h6>
                <p><strong>${data.distancia?.metros ? data.distancia.metros.toFixed(2) + 'm' : 'N/A'}</strong> 
                ${data.distancia?.km ? '(' + data.distancia.km + 'km)' : ''}</p>
            </div>
            <div class="col-md-6">
                <h6>CTO Mais Próximo</h6>
                <p><strong>Nome:</strong> ${data.cto?.nome || 'N/A'}</p>
                <p><strong>Arquivo:</strong> ${data.cto?.arquivo || 'N/A'}</p>
                <p><strong>Coordenadas:</strong> ${data.cto?.lat || 'N/A'}, ${data.cto?.lon || 'N/A'}</p>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
    document.getElementById('coordinates-results').style.display = 'block';
}
</script>
{% endblock %}

